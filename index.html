<!DOCTYPE html>
<html>
<head>
  <title>Catering Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #password-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f0f0f0;
    }
    #password-container input {
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    #password-container button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    #map { height: 90vh; width: 100%; display: none; }
    #region-controls {
      position: absolute;
      top: 10px;
      right: 120px;
      z-index: 1000;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      display: none;
    }
    #region-controls button, #region-controls select {
      margin-right: 5px;
    }
    #map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 16px;
      display: none;
    }
  </style>
</head>
<body>

<div id="password-container">
  <h2>Enter password to access Catering Map</h2>
  <form id="password-form">
    <input type="password" id="password-input" placeholder="Password" required>
    <button type="submit">Submit</button>
  </form>
  <p id="password-error" style="color:red; display:none;">Incorrect password ‚ùå</p>
</div>

<div id="map-title">Catering Map</div>
<div id="region-controls">
  <button id="eu-btn">EU</button>
  <select id="eu-select" style="display:none;" onchange="flyToEU(this.value)">
    <option value="">Select a country</option>
    <option value="UK">UK</option>
    <option value="France">France</option>
    <option value="Italy">Italy</option>
    <option value="Spain">Spain</option>
  </select>
  <button onclick="flyToRegion('US')">US</button>
  <button onclick="flyToRegion('APAC')">APAC</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const PASSWORD = "Catering2025";

document.getElementById('password-form').addEventListener('submit', function(e){
  e.preventDefault(); // Emp√™che le rechargement de la page
  const input = document.getElementById('password-input').value;
  if(input === PASSWORD){
    document.getElementById('password-container').style.display = 'none';
    document.getElementById('map').style.display = 'block';
    document.getElementById('map-title').style.display = 'block';
    document.getElementById('region-controls').style.display = 'block';
    initMap();
  } else {
    document.getElementById('password-error').style.display = 'block';
  }
});

function initMap(){
  const map = L.map('map').setView([51.5, -0.6], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // Ic√¥nes
  const airportIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893979.png', iconSize:[50,50], iconAnchor:[16,32]});
  const catererIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/1940/1940981.png', iconSize:[40,40], iconAnchor:[14,28]});
  const pixelRadius = 120;

  // Contr√¥les r√©gions
  let euDropdownVisible = false;
  document.getElementById('eu-btn').onclick = () => {
    const dropdown = document.getElementById('eu-select');
    if(!euDropdownVisible){
      dropdown.style.display = 'inline-block';
      map.flyTo([50, 10], 5);
      euDropdownVisible = true;
    } else {
      dropdown.style.display = 'none';
      dropdown.value = "";
      euDropdownVisible = false;
    }
  };

  window.flyToEU = (country)=>{
    switch(country){
      case 'UK': map.flyTo([54, -2], 6); break;
      case 'France': map.flyTo([46.5, 2], 6); break;
      case 'Italy': map.flyTo([42.5, 12], 6); break;
      case 'Spain': map.flyTo([40, -3], 6); break;
    }
  }

  window.flyToRegion = (region)=>{
    document.getElementById('eu-select').style.display = 'none';
    document.getElementById('eu-select').value = "";
    euDropdownVisible = false;
    
    if(region==='US') map.flyTo([39, -98], 5);
    else if(region==='APAC') map.flyTo([0, 120], 4);
  }

  // Chargement Google Sheet
  const SHEET_ID = "1r1RDAQkpflVXsEpt_Xt1X5qWaFueY9ulRI9lZ7on-2Y";
  const SHEET_NAME = "Sheet1";
  const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

  fetch(API_URL)
    .then(response => response.json())
    .then(rows => {
      const airports = {};
      rows.forEach(r => {
        const name = r["Airport Name"];
        if(!airports[name]){
          airports[name] = { name, lat: parseFloat(r["Latitude"]), lon: parseFloat(r["Longitude"]), caterers: [] };
        }
        airports[name].caterers.push({
          name: r["Caterer Name"], url: r["Caterer URL"], email: r["Caterer Email"], phone: r["Caterer Phone"]
        });
      });

      let currentlyVisible = null;

      Object.values(airports).forEach(airport => {
        const airportMarker = L.marker([airport.lat, airport.lon], {icon: airportIcon, title: airport.name})
          .addTo(map)
          .bindTooltip(airport.name, {direction:"top", offset:[0,-10]});

        let catererMarkers = [];
        let catererLines = [];
        let visible = false;

        function updatePositions(){
          const airportPoint = map.latLngToLayerPoint([airport.lat, airport.lon]);
          const angleStep = (2 * Math.PI) / airport.caterers.length;
          airport.caterers.forEach((c,i)=>{
            const angle = i * angleStep;
            const x = airportPoint.x + pixelRadius*Math.cos(angle);
            const y = airportPoint.y + pixelRadius*Math.sin(angle);
            const latlng = map.layerPointToLatLng([x,y]);
            catererMarkers[i].setLatLng(latlng);
            catererLines[i].setLatLngs([[airport.lat, airport.lon],[latlng.lat, latlng.lng]]);
          });
        }

        function hideCaterers(){
          catererMarkers.forEach(m=>map.removeLayer(m));
          catererLines.forEach(l=>map.removeLayer(l));
          catererMarkers=[]; catererLines=[];
          map.off('zoom', updatePositions);
          visible=false;
          if(currentlyVisible===airport) currentlyVisible=null;
        }

        function toggleCaterers(){
          if (currentlyVisible === airport) { hideCaterers(); return; }
          if (currentlyVisible && currentlyVisible !== airport) { currentlyVisible.hideCaterers(); }

          const angleStep = (2 * Math.PI) / airport.caterers.length;
          airport.caterers.forEach((c, i) => {
            const angle = i * angleStep;
            const airportPoint = map.latLngToLayerPoint([airport.lat, airport.lon]);
            const x = airportPoint.x + pixelRadius * Math.cos(angle);
            const y = airportPoint.y + pixelRadius * Math.sin(angle);
            const latlng = map.layerPointToLatLng([x, y]);
            const marker = L.marker(latlng, {icon: catererIcon, title: c.name})
              .addTo(map)
              .bindPopup(`<b>${c.name}</b><br>üåê <a href="${c.url}" target="_blank">${c.url}</a><br>üíª <a href="mailto:${c.email}">${c.email}</a><br>üìû <a href="tel:${c.phone}">${c.phone}</a>`)
              .bindTooltip(c.name, {direction:"top", offset:[0,-10]});
            const line = L.polyline([[airport.lat, airport.lon], [latlng.lat, latlng.lng]], {color:'black', dashArray:'4,4', weight:1, opacity:0.7}).addTo(map);
            catererMarkers.push(marker); catererLines.push(line);
          });

          map.on('zoom', updatePositions);
          visible = true;
          currentlyVisible = airport;
        }

        airport.hideCaterers = hideCaterers;
        airportMarker.on('click', toggleCaterers);
      });
    })
    .catch(err=>console.error("Error loading sheet:", err));
}
</script>
</body>
</html>
