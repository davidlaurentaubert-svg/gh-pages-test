<!DOCTYPE html>
<html>
<head>
  <title>Catering & Reps Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }

    #top-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    #top-controls button,
    #top-controls select {
      padding: 8px 14px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      background-color: #f8f8f8;
      transition: background-color 0.2s;
    }

    #top-controls button:hover,
    #top-controls select:hover {
      background-color: #eaeaea;
    }

    #map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
    }

    #search-bar {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 6px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #search-bar label {
      font-weight: bold;
    }

    #search-bar input {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
      min-width: 250px;
    }

    #suggestions {
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    #suggestions div {
      padding: 4px 8px;
      cursor: pointer;
    }

    #suggestions div:hover {
      background-color: #eee;
    }

    #not-found {
      color: red;
      font-weight: bold;
      margin-top: 2px;
      display: none;
    }

    hr.separator {
      height: 2px;
      background-color: #999;
      border: none;
      margin: 0 5px;
      align-self: stretch;
    }
  </style>
</head>
<body>

<script>
const PASSWORD = "Catering2025";
function askPassword() {
  const userInput = prompt("Enter password to access the map:");
  if(userInput === PASSWORD){
    return true;
  } else {
    alert("Incorrect password. Access denied.");
    window.location.href = "about:blank";
    return false;
  }
}
if(!askPassword()){
  throw new Error("Access denied");
}
</script>

<div id="map"></div>
<div id="map-title">Catering & Reps Map</div>

<!-- Barre de recherche -->
<div id="search-bar">
  <label for="search-input">Search Airport, IATA, or ICAO:</label>
  <input type="text" id="search-input" placeholder="Type airport name, IATA or ICAO code">
  <div id="suggestions"></div>
  <div id="not-found">Not Found</div>
</div>

<!-- Contr√¥les du haut (r√©gions et type) -->
<div id="top-controls">
  <button id="eu-btn">EU</button>
  <select id="eu-select" style="display:none;" onchange="flyToEU(this.value)">
    <option value="">Select country</option>
    <option value="UK">UK</option>
    <option value="France">France</option>
    <option value="Italy">Italy</option>
    <option value="Spain">Spain</option>
  </select>
  <button onclick="flyToRegion('US')">US</button>
  <button onclick="flyToRegion('APAC')">APAC</button>
  <hr class="separator">
  <button onclick="loadType('Caterers')">Caterers</button>
  <button onclick="loadType('Reps')">Reps</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([51.5, -0.6], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const airportIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/7893/7893979.png', iconSize:[50,50], iconAnchor:[16,32]});
const catererIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/1940/1940981.png', iconSize:[40,40], iconAnchor:[14,28]});
const repIcon = L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/6356/6356705.png', iconSize:[40,40], iconAnchor:[14,28]});

const pixelRadius = 120;
let euDropdownVisible = false;
let airports = {}; 
let currentlyVisible = null;
let airportMarkers = [];

// --- Boutons r√©gions
document.getElementById('eu-btn').onclick = () => {
  const dropdown = document.getElementById('eu-select');
  if(!euDropdownVisible){
    dropdown.style.display = 'inline-block';
    map.flyTo([50, 10], 5);
    euDropdownVisible = true;
  } else {
    dropdown.style.display = 'none';
    dropdown.value = "";
    euDropdownVisible = false;
  }
};

function flyToEU(country){
  switch(country){
    case 'UK': map.flyTo([54, -2], 6); break;
    case 'France': map.flyTo([46.5, 2], 6); break;
    case 'Italy': map.flyTo([42.5, 12], 6); break;
    case 'Spain': map.flyTo([40, -3], 6); break;
  }
}

function flyToRegion(region){
  document.getElementById('eu-select').style.display = 'none';
  document.getElementById('eu-select').value = "";
  euDropdownVisible = false;
  
  if(region==='US') map.flyTo([39, -98], 5);
  else if(region==='APAC') map.flyTo([0, 120], 4);
}

// --- Normalisation texte
function normalizeText(text){
  return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

// --- Chargement des markers depuis Google Sheet
function loadType(type){
  if(airportMarkers.length > 0){
    airportMarkers.forEach(m => map.removeLayer(m));
    airportMarkers = [];
  }
  if(currentlyVisible){
    Object.values(airports).forEach(a => a.hideMarkers && a.hideMarkers());
    currentlyVisible = null;
  }
  airports = {};

  const SHEET_ID = "1r1RDAQkpflVXsEpt_Xt1X5qWaFueY9ulRI9lZ7on-2Y";
  const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/${type}`;

  fetch(API_URL)
    .then(res => res.json())
    .then(rows => {
      rows.forEach(r => {
        const name = r["Airport Name"];
        const iata = r["IATA"] || "";
        const icao = r["ICAO"] || ""; // <-- ‚úÖ Nouvelle colonne ICAO
        if(!airports[name]){
          airports[name] = { name, iata, icao, lat: parseFloat(r["Latitude"]), lon: parseFloat(r["Longitude"]), markersData: [] };
        }

        if(type === "Caterers"){
          airports[name].markersData.push({
            name: r["Caterer Name"], url: r["Caterer URL"], email: r["Caterer Email"], phone: r["Caterer Phone"]
          });
        } else if(type === "Reps"){
          airports[name].markersData.push({
            name: r["Rep Name"], email: r["Rep Email"], phone: r["Rep Phone"]
          });
        }
      });

      Object.values(airports).forEach(airport => {
        const airportMarker = L.marker([airport.lat, airport.lon], {icon: airportIcon, title: airport.name})
          .addTo(map)
          .bindTooltip(`${airport.name}${airport.iata ? " ("+airport.iata+")" : ""}${airport.icao ? " ["+airport.icao+"]" : ""}`, {direction:"top", offset:[0,-10]});
        airportMarkers.push(airportMarker);

        let markers = [], lines = [], visible = false;

        function updatePositions(){
          const airportPoint = map.latLngToLayerPoint([airport.lat, airport.lon]);
          const angleStep = (2 * Math.PI) / airport.markersData.length;
          airport.markersData.forEach((m,i)=>{
            const angle = i*angleStep;
            const x = airportPoint.x + pixelRadius*Math.cos(angle);
            const y = airportPoint.y + pixelRadius*Math.sin(angle);
            const latlng = map.layerPointToLatLng([x,y]);
            markers[i].setLatLng(latlng);
            lines[i].setLatLngs([[airport.lat, airport.lon],[latlng.lat, latlng.lng]]);
          });
        }

        function toggleMarkers(){
          if(currentlyVisible && currentlyVisible!==airport){
            currentlyVisible.hideMarkers();
          }
          if(!visible && airport.markersData.length>0){
            const angleStep = (2*Math.PI)/airport.markersData.length;
            airport.markersData.forEach((m,i)=>{
              const angle = i*angleStep;
              const airportPoint = map.latLngToLayerPoint([airport.lat, airport.lon]);
              const x = airportPoint.x + pixelRadius*Math.cos(angle);
              const y = airportPoint.y + pixelRadius*Math.sin(angle);
              const latlng = map.layerPointToLatLng([x,y]);
              const icon = (type==="Caterers") ? catererIcon : repIcon;

              let popupContent = `<b>${m.name}</b>`;
              if(type==="Caterers"){
                popupContent += `<br>üåê <a href="${m.url}" target="_blank">${m.url}</a>`;
              }
              popupContent += `<br>üíª <a href="mailto:${m.email}">${m.email}</a>`;
              popupContent += `<br>üìû <a href="tel:${m.phone}">${m.phone}</a>`;

              const marker = L.marker(latlng,{icon, title:m.name})
                .addTo(map)
                .bindPopup(popupContent)
                .bindTooltip(m.name,{direction:"top",offset:[0,-10]});
              const line = L.polyline([[airport.lat, airport.lon],[latlng.lat, latlng.lng]], {color:'black', dashArray:'4,4', weight:1, opacity:0.7}).addTo(map);
              markers.push(marker);
              lines.push(line);
            });
            map.on('zoom', updatePositions);
            visible = true;
            currentlyVisible = airport;
          } else {
            airport.hideMarkers();
          }
        }

        airport.hideMarkers = function(){
          markers.forEach(m=>map.removeLayer(m));
          lines.forEach(l=>map.removeLayer(l));
          markers=[];
          lines=[];
          map.off('zoom', updatePositions);
          visible=false;
          if(currentlyVisible===airport) currentlyVisible=null;
        }

        airportMarker.on('click', toggleMarkers);
      });
    })
    .catch(err=>console.error("Error loading sheet:", err));
}

// --- Autocompletion avec navigation clavier (nom, IATA, ICAO)
const input = document.getElementById('search-input');
const suggestionsDiv = document.getElementById('suggestions');
const notFoundDiv = document.getElementById('not-found');
let selectedIndex = -1;

function updateSuggestions(){
  const query = normalizeText(input.value.trim());
  suggestionsDiv.innerHTML = '';
  notFoundDiv.style.display = 'none';
  selectedIndex = -1;

  if(!query) { suggestionsDiv.style.display = 'none'; return; }

  const matches = Object.values(airports)
    .filter(a => normalizeText(a.name).includes(query) || normalizeText(a.iata).includes(query) || normalizeText(a.icao).includes(query))
    .slice(0,10);

  if(matches.length === 0){
    suggestionsDiv.style.display = 'none';
    return;
  }

  matches.forEach((a, idx)=>{
    const display = `${a.name}${a.iata ? " ("+a.iata+")" : ""}${a.icao ? " ["+a.icao+"]" : ""}`;
    const div = document.createElement('div');
    div.textContent = display;
    div.onclick = ()=> {
      map.flyTo([a.lat, a.lon], 7);
      suggestionsDiv.style.display = 'none';
      input.value = a.name;
    };
    div.dataset.index = idx;
    suggestionsDiv.appendChild(div);
  });

  suggestionsDiv.style.display = 'block';
}

function highlightItem(){
  const items = suggestionsDiv.querySelectorAll('div');
  items.forEach((item, idx)=>{
    item.style.backgroundColor = (idx === selectedIndex) ? '#ddd' : '';
  });
}

input.addEventListener('input', updateSuggestions);

input.addEventListener('keydown', function(e){
  const items = suggestionsDiv.querySelectorAll('div');
  if(e.key === 'ArrowDown'){
    e.preventDefault();
    if(selectedIndex < items.length - 1) selectedIndex++;
    highlightItem();
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    if(selectedIndex > 0) selectedIndex--;
    highlightItem();
  } else if(e.key === 'Enter'){
    e.preventDefault();
    if(selectedIndex >= 0){
      const item = items[selectedIndex];
      const name = item.textContent.split(" (")[0];
      const airport = Object.values(airports).find(a => a.name === name);
      if(airport){
        map.flyTo([airport.lat, airport.lon], 7);
        input.value = airport.name;
      }
      suggestionsDiv.style.display = 'none';
      notFoundDiv.style.display = 'none';
    } else {
      const query = normalizeText(input.value.trim());
      const found = Object.values(airports).find(a => normalizeText(a.name).includes(query) || normalizeText(a.iata).includes(query) || normalizeText(a.icao).includes(query));
      if(found){
        map.flyTo([found.lat, found.lon], 7);
        suggestionsDiv.style.display = 'none';
        notFoundDiv.style.display = 'none';
      } else {
        notFoundDiv.style.display = 'block';
      }
    }
  }
});

// Charger par d√©faut
loadType('Caterers');
</script>
</body>
</html>
