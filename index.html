<script>
const map = L.map('map').setView([51.5, -0.6], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const airportIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/7893/7893979.png',iconSize:[50,50],iconAnchor:[16,32]});
const catererIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/1940/1940981.png',iconSize:[40,40],iconAnchor:[14,28]});
const repIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/256/6429/6429949.png',iconSize:[40,40],iconAnchor:[14,28]});

const pixelRadius = 120;
let euDropdownVisible = false;
let airports = {};
let currentlyVisible = null;
let allMarkers = []; // <-- tableau global pour tous les markers et lignes

function clearAllMarkers() {
  allMarkers.forEach(m=>map.removeLayer(m));
  allMarkers = [];
  currentlyVisible = null;
}

function loadType(type){
  clearAllMarkers(); // <-- supprime tout avant de charger le type

  const API_URL = `/.netlify/functions/get-sheet-data?type=${type}`;
  fetch(API_URL)
    .then(res=>res.text())
    .then(csvText=>{
      const rows = Papa.parse(csvText,{header:true}).data;
      airports = {};

      rows.forEach(r=>{
        const name = r["Airport Name"];
        if(!airports[name]){
          airports[name] = { name, lat: parseFloat(r["Latitude"]), lon: parseFloat(r["Longitude"]), markers:[] };
        }

        if(type==="Caterers"){
          airports[name].markers.push({ name:r["Caterer Name"], url:r["Caterer URL"], email:r["Caterer Email"], phone:r["Caterer Phone"] });
        } else if(type==="Reps"){
          airports[name].markers.push({ name:r["Rep Name"], email:r["Rep Email"], phone:r["Rep Phone"] });
        }
      });

      Object.values(airports).forEach(airport=>{
        const airportMarker = L.marker([airport.lat,airport.lon],{icon:airportIcon,title:airport.name}).addTo(map)
          .bindTooltip(airport.name,{direction:"top",offset:[0,-10]});
        allMarkers.push(airportMarker);

        let visible = false;
        let markers=[], lines=[];

        function updatePositions(){
          const airportPoint = map.latLngToLayerPoint([airport.lat,airport.lon]);
          const angleStep = (2*Math.PI)/markers.length;
          markers.forEach((m,i)=>{
            const angle = i*angleStep;
            const x = airportPoint.x + pixelRadius*Math.cos(angle);
            const y = airportPoint.y + pixelRadius*Math.sin(angle);
            const latlng = map.layerPointToLatLng([x,y]);
            m.setLatLng(latlng);
            lines[i].setLatLngs([[airport.lat,airport.lon],[latlng.lat,latlng.lng]]);
          });
        }

        function toggleMarkers(){
          if(visible){
            markers.forEach(m=>map.removeLayer(m));
            lines.forEach(l=>map.removeLayer(l));
            markers=[]; lines=[];
            map.off('zoom',updatePositions);
            visible=false;
            currentlyVisible=null;
          } else {
            const angleStep = (2*Math.PI)/airport.markers.length;
            airport.markers.forEach((m,i)=>{
              const angle = i*angleStep;
              const airportPoint = map.latLngToLayerPoint([airport.lat,airport.lon]);
              const x = airportPoint.x + pixelRadius*Math.cos(angle);
              const y = airportPoint.y + pixelRadius*Math.sin(angle);
              const latlng = map.layerPointToLatLng([x,y]);
              const icon = (type==="Caterers") ? catererIcon : repIcon;

              let popupContent = `<b>${m.name}</b>`;
              if(type==="Caterers") popupContent+=`<br>üåê <a href="${m.url}" target="_blank">${m.url}</a>`;
              popupContent+=`<br>üíª <a href="mailto:${m.email}">${m.email}</a>`;
              popupContent+=`<br>üìû <a href="tel:${m.phone}">${m.phone}</a>`;

              const marker = L.marker(latlng,{icon,title:m.name}).addTo(map).bindPopup(popupContent)
                .bindTooltip(m.name,{direction:"top",offset:[0,-10]});
              const line = L.polyline([[airport.lat,airport.lon],[latlng.lat,latlng.lng]],{color:'black',dashArray:'4,4',weight:1,opacity:0.7}).addTo(map);

              markers.push(marker);
              lines.push(line);
              allMarkers.push(marker,line); // <-- ajout au tableau global
            });
            map.on('zoom',updatePositions);
            visible=true;
            currentlyVisible=airport;
          }
        }

        airportMarker.on('click',toggleMarkers);
      });
    })
    .catch(err=>console.error("Error loading sheet:",err));
}

// Charger par d√©faut les Caterers
loadType('Caterers');
</script>
