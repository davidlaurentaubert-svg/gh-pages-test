let allAirportMarkers = []; // <-- nouvelle variable globale

function loadType(type) {
  // Supprimer tous les anciens markers de la carte
  allAirportMarkers.forEach(a => {
    a.airportMarker && map.removeLayer(a.airportMarker);
    a.markers.forEach(m => map.removeLayer(m.marker));
    a.lines.forEach(l => map.removeLayer(l));
  });
  allAirportMarkers = [];
  currentlyVisibleType = null;

  fetch(`/.netlify/functions/get-sheet-data?type=${type}`)
    .then(res => res.text())
    .then(csvText => {
      const rows = Papa.parse(csvText,{header:true}).data;
      const newAirports = {};

      rows.forEach(r => {
        const name = r["Airport Name"];
        if(!newAirports[name]) newAirports[name] = {name, lat: parseFloat(r["Latitude"]), lon: parseFloat(r["Longitude"]), markers:[], lines:[], airportMarker:null};
        if(type === "Caterers"){
          newAirports[name].markers.push({
            name: r["Caterer Name"],
            url: r["Caterer URL"],
            email: r["Caterer Email"],
            phone: r["Caterer Phone"]
          });
        } else {
          newAirports[name].markers.push({
            name: r["Rep Name"],
            email: r["Rep Email"],
            phone: r["Rep Phone"]
          });
        }
      });

      Object.values(newAirports).forEach(airport => {
        const airportMarker = L.marker([airport.lat, airport.lon], {icon: airportIcon, title: airport.name})
          .addTo(map)
          .bindTooltip(airport.name,{direction:"top",offset:[0,-10]});
        airport.airportMarker = airportMarker;

        airportMarker.on('click', () => {
          if(currentlyVisibleType && currentlyVisibleType !== airport) {
            currentlyVisibleType.markers.forEach(m => m.marker && map.removeLayer(m.marker));
            currentlyVisibleType.lines.forEach(l => map.removeLayer(l));
          }

          if(airport.markers.length === 0) return;

          airport.markers.forEach((m, i) => {
            if(!m.marker){
              const angleStep = (2*Math.PI)/airport.markers.length;
              const angle = i*angleStep;
              const airportPoint = map.latLngToLayerPoint([airport.lat, airport.lon]);
              const x = airportPoint.x + pixelRadius*Math.cos(angle);
              const y = airportPoint.y + pixelRadius*Math.sin(angle);
              const latlng = map.layerPointToLatLng([x,y]);
              const icon = type==="Caterers" ? catererIcon : repIcon;

              let popupContent = `<b>${m.name}</b>`;
              if(type==="Caterers") popupContent += `<br>ğŸŒ <a href="${m.url}" target="_blank">${m.url}</a>`;
              popupContent += `<br>ğŸ’» <a href="mailto:${m.email}">${m.email}</a>`;
              popupContent += `<br>ğŸ“ <a href="tel:${m.phone}">${m.phone}</a>`;

              m.marker = L.marker(latlng,{icon,title:m.name})
                .addTo(map)
                .bindPopup(popupContent)
                .bindTooltip(m.name,{direction:"top",offset:[0,-10]});
              const line = L.polyline([[airport.lat,airport.lon],[latlng.lat,latlng.lng]],{color:'black',dashArray:'4,4',weight:1,opacity:0.7}).addTo(map);
              airport.lines.push(line);
            }
          });
          currentlyVisibleType = airport;
        });

        allAirportMarkers.push(airport);
      });

    }).catch(err => console.error("Error loading sheet:",err));
}
